<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ICS Maker</title>

  <!-- Modern clean font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", sans-serif;
      margin: 0;
      padding: 0;
      background: #eef0f2;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .card {
      background: white;
      padding: 2.2rem 2.8rem;
      max-width: 480px;
      width: calc(100% - 2rem);
      border-radius: 16px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.12);
      text-align: center;
      animation: fadein 0.4s ease-out;
    }

    @keyframes fadein {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    #status {
      font-size: 1.25rem;
      font-weight: 500;
      color: #222;
      margin-bottom: 0.8rem;
    }

    p {
      margin: 0.7rem 0;
      color: #444;
      font-size: 1.05rem;
    }

    a {
      color: #0066cc;
      text-decoration: none;
      font-weight: 500;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="card">
    <p id="status">Preparing your calendar file… it should download automatically.</p>
    <p id="fallback"></p>
  </div>

  <script>
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function parseDateToYmd(s) {
      if (!s) return null;
      s = s.trim();

      let d;
      if (s.includes("/")) {
        const [dd, mm, yyyy] = s.split("/");
        d = new Date(+yyyy, +mm - 1, +dd);
      } else if (s.includes("-")) {
        d = new Date(s);
      } else {
        return null;
      }

      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}${m}${day}`;
    }

    const title = getParam("title") || "Event";
    const startRaw = getParam("start");
    const endRaw = getParam("end");

    const baseUrlParam = getParam("url");
    const hash = window.location.hash || "";

    const urlParam = baseUrlParam
      ? (baseUrlParam.includes("#") ? baseUrlParam : baseUrlParam + hash)
      : null;

    const startYmd = parseDateToYmd(startRaw);
    const endYmd = parseDateToYmd(endRaw);
    const uid = getParam("uid") || "0";

    function escapeIcs(s) {
      return s ? s.replace(/[\r\n]/g, "").trim() : "";
    }

    function goBackOrFallback() {
      const status = document.getElementById("status");

      if (window.history.length > 1) {
        status.textContent =
          "Your calendar file has been created — returning to the previous page…";
        setTimeout(() => window.history.back(), 1000);
      } else {
        status.textContent =
          "Your calendar file has been generated.";
        document.getElementById("fallback").innerHTML =
          "You may now close this tab.";
      }
    }

    if (!startYmd || !endYmd) {
      document.querySelector(".card").innerHTML =
        "<p>Missing or invalid start/end date.</p>";
    } else {
      const now = new Date();
      const dtstamp =
        now.getUTCFullYear().toString() +
        String(now.getUTCMonth() + 1).padStart(2, "0") +
        String(now.getUTCDate()).padStart(2, "0") +
        "T" +
        String(now.getUTCHours()).padStart(2, "0") +
        String(now.getUTCMinutes()).padStart(2, "0") +
        String(now.getUTCSeconds()).padStart(2, "0") +
        "Z";

      const ics =
        "BEGIN:VCALENDAR\r\n" +
        "VERSION:2.0\r\n" +
        "PRODID:-//Generic ICS Maker//EN\r\n" +
        "BEGIN:VEVENT\r\n" +
        "UID:" + uid + "@generic-ics\r\n" +
        "DTSTAMP:" + dtstamp + "\r\n" +
        "DTSTART;VALUE=DATE:" + startYmd + "\r\n" +
        "DTEND;VALUE=DATE:" + endYmd + "\r\n" +
        "SUMMARY:" + title + "\r\n" +
        (urlParam ? "URL:" + escapeIcs(urlParam) + "\r\n" : "") +
        "END:VEVENT\r\n" +
        "END:VCALENDAR\r\n";

      const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      const safeTitle = title.replace(/[^A-Za-z0-9-_]+/g, "-") || "event";
      a.download = safeTitle + "-" + uid + ".ics";
      document.body.appendChild(a);
      a.click();

      document.getElementById("fallback").innerHTML =
        'If your download did not start, <a href="' +
        url +
        '" download="' +
        a.download +
        '">click here</a>.';

      document.getElementById("status").textContent =
        "Your calendar file has been created — returning to the previous page…";

      setTimeout(goBackOrFallback, 1200);
    }
  </script>
</body>
</html>

