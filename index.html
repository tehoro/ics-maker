<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ICS Maker</title>

  <!-- Modern clean font -->
  <link href="https://fonts.googleapis.com/css2?&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", sans-serif;
      font-size: 1.15rem;
      line-height: 1.5;
      margin: 0;
      padding: 2.5rem;
      text-align: center;
      color: #202020;
      background: #f7f7f7;
    }

    #status {
      font-weight: 500;
      margin-bottom: 1rem;
    }

    p {
      margin-top: 1rem;
    }

    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

  </style>
</head>
<body>
  <p id="status">Preparing your calendar file… it should download automatically.</p>

  <script>
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function parseDateToYmd(s) {
      if (!s) return null;
      s = s.trim();

      // Support DD/MM/YYYY (Knack) or YYYY-MM-DD
      let d;
      if (s.includes("/")) {
        const [dd, mm, yyyy] = s.split("/");
        d = new Date(+yyyy, +mm - 1, +dd);
      } else if (s.includes("-")) {
        d = new Date(s);
      } else {
        return null;
      }

      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}${m}${day}`;
    }

    const title    = getParam("title") || "Event";
    const startRaw = getParam("start");
    const endRaw   = getParam("end");

    const baseUrlParam = getParam("url");
    const hash = window.location.hash || "";

    const urlParam = baseUrlParam
        ? (baseUrlParam.includes("#") ? baseUrlParam : baseUrlParam + hash)
        : null;

    const startYmd = parseDateToYmd(startRaw);
    const endYmd   = parseDateToYmd(endRaw);
    const uid      = getParam("uid") || "0";

    function escapeIcs(s) {
      if (!s) return "";
      return s.replace(/[\r\n]/g, "").trim();
    }

    function goBackOrFallback() {
      const status = document.getElementById("status");

      if (window.history.length > 1) {
        status.textContent =
          "Your calendar file has been created — returning to the previous page in 2 seconds…";
        setTimeout(() => window.history.back(), 1500);
      } else {
        status.innerHTML =
          "Your calendar file has downloaded. You may close this tab.";
      }
    }

    if (!startYmd || !endYmd) {
      document.body.innerHTML = "<p>Missing or invalid start/end date.</p>";
    } else {
      const now = new Date();
      const dtstamp =
        now.getUTCFullYear().toString() +
        String(now.getUTCMonth() + 1).padStart(2, "0") +
        String(now.getUTCDate()).padStart(2, "0") +
        "T" +
        String(now.getUTCHours()).padStart(2, "0") +
        String(now.getUTCMinutes()).padStart(2, "0") +
        String(now.getUTCSeconds()).padStart(2, "0") +
        "Z";

      const ics =
        "BEGIN:VCALENDAR\r\n" +
        "VERSION:2.0\r\n" +
        "PRODID:-//Generic ICS Maker//EN\r\n" +
        "BEGIN:VEVENT\r\n" +
        "UID:" + uid + "@generic-ics\r\n" +
        "DTSTAMP:" + dtstamp + "\r\n" +
        "DTSTART;VALUE=DATE:" + startYmd + "\r\n" +
        "DTEND;VALUE=DATE:" + endYmd + "\r\n" +
        "SUMMARY:" + title + "\r\n" +
        (urlParam ? "URL:" + escapeIcs(urlParam) + "\r\n" : "") +
        "END:VEVENT\r\n" +
        "END:VCALENDAR\r\n";

      const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      const safeTitle = title.replace(/[^A-Za-z0-9-_]+/g, "-") || "event";
      a.download = safeTitle + "-" + uid + ".ics";
      document.body.appendChild(a);

      a.click();

      const fallback = document.createElement("p");
      fallback.innerHTML =
        'If your download did not start, ' +
        '<a href="' + url + '" download="' + a.download + '">click here</a>.';
      document.body.appendChild(fallback);

      const status = document.getElementById("status");
      status.textContent =
        "Your calendar file has been created — returning to the previous page in 2 seconds…";

      setTimeout(goBackOrFallback, 1500);
    }
  </script>
</body>
</html>
