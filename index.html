<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ICS Maker</title>
</head>
<body>
  <p>Preparing your calendar fileâ€¦</p>
  <script>
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function parseDateToYmd(s) {
      if (!s) return null;
      s = s.trim();

      // Support DD/MM/YYYY (what Knack is showing you) or YYYY-MM-DD
      let d;
      if (s.includes("/")) {
        const [dd, mm, yyyy] = s.split("/");
        d = new Date(+yyyy, +mm - 1, +dd);
      } else if (s.includes("-")) {
        d = new Date(s);
      } else {
        return null;
      }

      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}${m}${day}`;
    }

    const title    = getParam("title") || "Event";
    const startRaw = getParam("start");
    const endRaw   = getParam("end");

    // Base URL from the query string
    const baseUrlParam = getParam("url");

    // Fragment part from the outer URL (anything after #)
    const hash = window.location.hash || "";

    // Compose the full URL: if base already contains a '#', use it as-is;
    // otherwise append the fragment from the outer URL
    const urlParam = baseUrlParam
        ? (baseUrlParam.includes("#") ? baseUrlParam : baseUrlParam + hash)
        : null;

    const startYmd = parseDateToYmd(startRaw);
    const endYmd   = parseDateToYmd(endRaw);
    const uid      = getParam("uid") || "0";


    function escapeIcs(s) {
      if (!s) return "";
      return s.replace(/[\r\n]/g, "").trim();
    }

    if (!startYmd || !endYmd) {
      document.body.innerHTML = "<p>Missing or invalid start/end date.</p>";
    } else {
      const now = new Date();
      const dtstamp =
        now.getUTCFullYear().toString() +
        String(now.getUTCMonth() + 1).padStart(2, "0") +
        String(now.getUTCDate()).padStart(2, "0") +
        "T" +
        String(now.getUTCHours()).padStart(2, "0") +
        String(now.getUTCMinutes()).padStart(2, "0") +
        String(now.getUTCSeconds()).padStart(2, "0") +
        "Z";

      const ics =
        "BEGIN:VCALENDAR\r\n" +
        "VERSION:2.0\r\n" +
        "PRODID:-//Generic ICS Maker//EN\r\n" +
        "BEGIN:VEVENT\r\n" +
        "UID:" + uid + "@generic-ics\r\n" +
        "DTSTAMP:" + dtstamp + "\r\n" +
        "DTSTART;VALUE=DATE:" + startYmd + "\r\n" +
        "DTEND;VALUE=DATE:" + endYmd + "\r\n" +
        "SUMMARY:" + title + "\r\n" +
        (urlParam ? "URL:" + escapeIcs(urlParam) + "\r\n" : "") +
        "END:VEVENT\r\n" +
        "END:VCALENDAR\r\n";

      const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      const safeTitle = title.replace(/[^A-Za-z0-9-_]+/g, "-") || "event";
      a.download = safeTitle + "-" + uid + ".ics";
      document.body.appendChild(a);
      a.click();

      const p = document.createElement("p");
      p.innerHTML =
        'If your download did not start, ' +
        '<a href="' + url + '" download="' + a.download + '">click here</a>.';
      document.body.appendChild(p);
    }
  </script>
</body>
</html>
